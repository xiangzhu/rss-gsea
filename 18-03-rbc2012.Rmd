## GSEA Round 2 {#rbc2012-2}

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

### Fit the null model

From the Round 1 null analysis (Section \@ref(ibd2015-1)), I found that almost 99.9% posterior mass is concentrated on the settings `theta0=-3.5` and `h=(0.3:0.1:0.6)'`. In Round 2, I used a finer grid. Specifically, I used the grids `theta0=(-3.75:0.025:-3.25)'` and `h=(0.3:0.1:0.6)'` when fitting the null model. I estimated the (unnormalized) log importance weights ("pseudo-likelihoods") for all 84 sets of `(h,theta0)` under null.

```{r,echo=FALSE}
knitr::include_graphics("images/rbc2012_null_round2.png", dpi=NA)
```

After normalizing the log "pseudo-likelihoods" (`logw.step*`) to posterior probabilities (`posp.step*`), we can see that almost 99.97% of the posterior mass is concentrated on the settings `theta0=(-3.7:0.025:-3.6)'` and `h=(0.5:0.1:0.6)'`.
```{r, include=FALSE}
null.path <- "~/Dropbox/rss/Data/rbc_2012/pathway/rbc2012_null_201609.mat"
null.df <- null.mat2df(null.path)
```

```{r, echo=FALSE}
source("src/null_dt.R")
null.dt
```

```{r}
h.index <- as.character(null.df$h) %in% as.character(c(0.5,0.6))  
theta0.index <- as.character(null.df$theta0) %in% as.character(seq(-3.7,-3.6,by=0.025)) 

sum(null.df$posp.step1[intersect(theta0.index, h.index)]) 
sum(null.df$posp.step2[intersect(theta0.index, h.index)]) 
```

### Fit the enrichment model

To perform GSEA, I set `theta0=(-3.7:0.025:-3.6)'` and `h=(0.5:0.1:0.6)'`, since the null analysis suggests that almost 99.97% of the posterior mass is placed on these settings. For the log-fold enrichment parameter, I use the grid `theta = (0:(3.5/100):3.5)'`. The following table lists the GSEA results. 
```{r, include=FALSE}
gsea.path <- "~/Dropbox/rss/Data/rbc_2012/pathway/rbc2012_pathway_201609.mat"
gsea.df <- gsea.mat2df.round2(gsea.path) 
```

```{r, echo=FALSE}
source("src/gsea_dt_round2.R")
gsea.dt
```

Now we compare the enrichment Bayes factors from Round 1 and 2 analyses.

```{r, include=FALSE}
gsea.path <- "~/Dropbox/rss/Data/rbc_2012/pathway/rbc2012_pathway_201604.mat"
gsea.df.round1 <- gsea.mat2df(gsea.path) 

bf.round1 <- gsea.df.round1[, c("id","name","source","database","numgene","numsnps","log10.bf")]
bf.round2 <- gsea.df[, c("id","name","source","database","numgene","numsnps","log10.bf")]
bf.df <- merge(bf.round1, bf.round2, by=c("id","name","source","database","numgene","numsnps"))
names(bf.df)[7:8] <- c("round1.log10.bf", "round2.log10.bf")
```

```{r, echo=FALSE}
fit <- lm(round2.log10.bf~round1.log10.bf-1, data=bf.df)

plotly::plot_ly(data=bf.df, x=round1.log10.bf, y=round2.log10.bf, mode="markers",
                text=paste0("ID: ",id,"; Name: ",name), color=numsnps, size=numgene) %>% add_trace(x=c(0,400), y=c(0,400), mode="lines") %>% add_trace(x=round1.log10.bf, y=fitted(fit), mode="lines") %>% layout(showlegend=F) 
```


