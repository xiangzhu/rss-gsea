## GSEA Round 1 {#hdl2010-1}

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

### Fit the null model

I used the grids `theta0=(-5:0.25:-2)'` and `h=(0.3:0.1:0.6)'` when fitting the null model. I estimated the (unnormalized) log importance weights ("pseudo-likelihoods") for all 52 sets of `(h,theta0)` under null.

```{r,echo=FALSE}
knitr::include_graphics("images/hdl2010_null_round1.png", dpi=NA)
```

After normalizing the log "pseudo-likelihoods" (`logw.step*`) to posterior probabilities (`posp.step*`), we can see that almost 100% posterior mass is concentrated on the combinations of `h=0.3` and `theta0=-3.5`.
```{r, include=FALSE}
null.path <- "~/Dropbox/rss/Data/hdl_2010/pathway/hdl2010_null_201604.mat"
null.df <- null.mat2df(null.path)
```

```{r, echo=FALSE}
source("src/null_dt.R")
null.dt
```

### Fit the enrichment model

To perform GSEA, I set `h=0.3` and `theta0=-3.5`, since the null analysis suggests that almost 100% posterior mass is placed on these settings. For the log-fold enrichment parameter, I use the grid `theta  = (0:(3.5/200):3.5)'`. The following table lists the GSEA results. 
```{r, include=FALSE}
gsea.path <- "~/Dropbox/rss/Data/hdl_2010/pathway/hdl2010_pathway_201604.mat"
gsea.df <- gsea.mat2df(gsea.path) 
```

```{r, echo=FALSE}
source("src/gsea_dt.R")
gsea.dt
```

To help decide the grid for `theta` in Round 2 enrichment analysis (Section \@ref(hdl2010-2)), I visualized the posterior mean, 95% lower and upper bound of `theta` for the top 100 enriched pathways identified in Round 1 analysis.

```{r}
gsea.df.sorted <- plyr::arrange(gsea.df, -log10.bf)
gsea.df.top100 <- gsea.df.sorted[1:100, ]

summary(gsea.df.top100[, c("theta.mean","theta.95lb","theta.95ub")])
summary(gsea.df.top100[, c("numgene","numsnps")])
```

```{r, echo=FALSE}
plot.df <- reshape2::melt(gsea.df.top100, id.vars=c("id", "name"), measure.vars=c("theta.mean","theta.95lb","theta.95ub"), variable.name="parameter", value.name="estimate")

plot_ly(plot.df, x=estimate, color=parameter, type="box")
```

### Enrichment analysis in GTEx

I also ran the GSEA using the clustering results of GTEx gene expression V6 data (20 clusters, each with 100 genes).
```{r, include=FALSE}
gtex.path <- "~/Dropbox/rss/Data/hdl_2010/pathway/hdl2010_gtexclust_201604.mat"
gtex.df <- gtex.mat2df(gtex.path) 
```

```{r, echo=FALSE}
source("src/gtex_dt.R")
gtex.dt
```


